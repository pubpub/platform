services:
    # s3-compatible object storage for local file uploads
    garage:
        env_file:
            - path: .env
              required: true
        extends:
            file: docker-compose.base.yml
            service: garage
        networks:
            - app-network
        volumes:
            - ./garage/garage.toml:/etc/garage.toml
            - garage-meta:/var/lib/garage/meta
            - garage-data:/var/lib/garage/data
        ports:
            - "3900:3900" # S3 API
            - "3902:3902" # Web hosting
            - "3903:3903" # Admin API

    db:
        env_file:
            - path: .env
              required: true
        extends:
            file: docker-compose.base.yml
            service: db
        volumes:
            - postgres-data:/var/lib/postgresql/data
        ports:
            - 54322:5432
        networks:
            - app-network

    inbucket:
        env_file:
            - path: .env
              required: true
        extends:
            file: docker-compose.base.yml
            service: inbucket
        networks:
            - app-network

    cache:
        env_file:
            - path: .env
              required: true
        extends:
            file: docker-compose.base.yml
            service: cache
        networks:
            - app-network
        ports:
            - 6379:6379

    garage-init:
        env_file:
            - path: .env
              required: true
        healthcheck:
            test: ["CMD", "echo", "true"]
            interval: 1m30s
            timeout: 30s
            retries: 5
            start_period: 30s
        extends:
            file: docker-compose.base.yml
            service: garage-init
        depends_on:
            garage:
                condition: service_healthy
        networks:
            - app-network

    # caddy reverse proxy for serving static sites from garage
    # access sites at http://localhost:8080/{communitySlug}/{subpath}/
    caddy:
        image: caddy:latest
        env_file:
            - path: .env
              required: true
        depends_on:
            garage-init:
                condition: service_completed_successfully
        volumes:
            - ../dev.Caddyfile:/etc/caddy/Caddyfile
        environment:
            - ASSETS_BUCKET_NAME=${ASSETS_BUCKET_NAME:-assets.v7.pubpub.org}
            - S3_REGION=${ASSETS_REGION:-garage}
            - S3_ENDPOINT=garage:3900
        ports:
            - "8080:8080"
        networks:
            - app-network

networks:
    app-network:

volumes:
    postgres-data:
        driver: local
    garage-meta:
        driver: local
    garage-data:
        driver: local
