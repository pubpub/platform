1:"$Sreact.fragment"
3:I[99805,["/platform/pr-preview/pr-1389/_next/static/chunks/aeacce398bb52d2f.js","/platform/pr-preview/pr-1389/_next/static/chunks/688156694ad04c7c.js"],"default"]
4:I[26909,["/platform/pr-preview/pr-1389/_next/static/chunks/aeacce398bb52d2f.js","/platform/pr-preview/pr-1389/_next/static/chunks/688156694ad04c7c.js"],"default"]
6:I[2273,["/platform/pr-preview/pr-1389/_next/static/chunks/aeacce398bb52d2f.js","/platform/pr-preview/pr-1389/_next/static/chunks/688156694ad04c7c.js"],"OutletBoundary"]
7:"$Sreact.suspense"
9:I[2273,["/platform/pr-preview/pr-1389/_next/static/chunks/aeacce398bb52d2f.js","/platform/pr-preview/pr-1389/_next/static/chunks/688156694ad04c7c.js"],"ViewportBoundary"]
b:I[2273,["/platform/pr-preview/pr-1389/_next/static/chunks/aeacce398bb52d2f.js","/platform/pr-preview/pr-1389/_next/static/chunks/688156694ad04c7c.js"],"MetadataBoundary"]
d:I[49486,[],"default"]
:HL["/platform/pr-preview/pr-1389/_next/static/chunks/9da88c9be4528e23.css","style"]
0:{"P":null,"b":"ZxuT62PsyuWQGSnk5WzO3","c":["","infrastructure","ecs-cluster"],"q":"","i":false,"f":[[["",{"children":[["mdxPath","infrastructure/ecs-cluster","oc"],{"children":["__PAGE__",{}]}]},"$undefined","$undefined",true],[["$","$1","c",{"children":[[["$","link","0",{"rel":"stylesheet","href":"/platform/pr-preview/pr-1389/_next/static/chunks/9da88c9be4528e23.css","precedence":"next","crossOrigin":"$undefined","nonce":"$undefined"}],["$","script","script-0",{"src":"/platform/pr-preview/pr-1389/_next/static/chunks/dd28ad6c648d3915.js","async":true,"nonce":"$undefined"}],["$","script","script-1",{"src":"/platform/pr-preview/pr-1389/_next/static/chunks/7c21ffbacf124703.js","async":true,"nonce":"$undefined"}],["$","script","script-2",{"src":"/platform/pr-preview/pr-1389/_next/static/chunks/40c2ac68a22f3b83.js","async":true,"nonce":"$undefined"}],["$","script","script-3",{"src":"/platform/pr-preview/pr-1389/_next/static/chunks/e2d6c8eabf052809.js","async":true,"nonce":"$undefined"}]],"$L2"]}],{"children":[["$","$1","c",{"children":[null,["$","$L3",null,{"parallelRouterKey":"children","error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L4",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","forbidden":"$undefined","unauthorized":"$undefined"}]]}],{"children":[["$","$1","c",{"children":["$L5",null,["$","$L6",null,{"children":["$","$7",null,{"name":"Next.MetadataOutlet","children":"$@8"}]}]]}],{},null,false,false]},null,false,false]},null,false,false],["$","$1","h",{"children":[null,["$","$L9",null,{"children":"$@a"}],["$","div",null,{"hidden":true,"children":["$","$Lb",null,{"children":["$","$7",null,{"name":"Next.Metadata","children":"$@c"}]}]}],null]}],false]],"m":"$undefined","G":["$d",[]],"s":false,"S":true}
e:I[95217,["/platform/pr-preview/pr-1389/_next/static/chunks/dd28ad6c648d3915.js","/platform/pr-preview/pr-1389/_next/static/chunks/7c21ffbacf124703.js","/platform/pr-preview/pr-1389/_next/static/chunks/40c2ac68a22f3b83.js","/platform/pr-preview/pr-1389/_next/static/chunks/e2d6c8eabf052809.js"],"ThemeConfigProvider"]
f:I[541,["/platform/pr-preview/pr-1389/_next/static/chunks/dd28ad6c648d3915.js","/platform/pr-preview/pr-1389/_next/static/chunks/7c21ffbacf124703.js","/platform/pr-preview/pr-1389/_next/static/chunks/40c2ac68a22f3b83.js","/platform/pr-preview/pr-1389/_next/static/chunks/e2d6c8eabf052809.js"],"LastUpdated"]
10:I[55747,["/platform/pr-preview/pr-1389/_next/static/chunks/dd28ad6c648d3915.js","/platform/pr-preview/pr-1389/_next/static/chunks/7c21ffbacf124703.js","/platform/pr-preview/pr-1389/_next/static/chunks/40c2ac68a22f3b83.js","/platform/pr-preview/pr-1389/_next/static/chunks/e2d6c8eabf052809.js"],"Search"]
11:I[81795,["/platform/pr-preview/pr-1389/_next/static/chunks/dd28ad6c648d3915.js","/platform/pr-preview/pr-1389/_next/static/chunks/7c21ffbacf124703.js","/platform/pr-preview/pr-1389/_next/static/chunks/40c2ac68a22f3b83.js","/platform/pr-preview/pr-1389/_next/static/chunks/e2d6c8eabf052809.js"],"ThemeProvider"]
12:I[17614,["/platform/pr-preview/pr-1389/_next/static/chunks/dd28ad6c648d3915.js","/platform/pr-preview/pr-1389/_next/static/chunks/7c21ffbacf124703.js","/platform/pr-preview/pr-1389/_next/static/chunks/40c2ac68a22f3b83.js","/platform/pr-preview/pr-1389/_next/static/chunks/e2d6c8eabf052809.js"],"SkipNavLink"]
13:I[35907,["/platform/pr-preview/pr-1389/_next/static/chunks/dd28ad6c648d3915.js","/platform/pr-preview/pr-1389/_next/static/chunks/7c21ffbacf124703.js","/platform/pr-preview/pr-1389/_next/static/chunks/40c2ac68a22f3b83.js","/platform/pr-preview/pr-1389/_next/static/chunks/e2d6c8eabf052809.js"],"ConfigProvider"]
2:["$","html",null,{"lang":"en","dir":"ltr","suppressHydrationWarning":true,"children":[["$","head",null,{"children":["$undefined",["$","style",null,{"children":":root {\n  --nextra-primary-hue: 212deg;\n  --nextra-primary-saturation: 100%;\n  --nextra-primary-lightness: 45%;\n  --nextra-bg: 250,250,250;\n  --nextra-content-width: 90rem;\n}\n.dark {\n  --nextra-primary-hue: 204deg;\n  --nextra-primary-saturation: 100%;\n  --nextra-primary-lightness: 55%;\n  --nextra-bg: 17,17,17;\n}\n::selection {\n  background: hsla(var(--nextra-primary-hue),var(--nextra-primary-saturation),var(--nextra-primary-lightness),.3);\n}\nhtml {\n  background: rgb(var(--nextra-bg));\n}"}],["$","meta",null,{"name":"theme-color","media":"(prefers-color-scheme: light)","content":"rgb(250,250,250)"}],["$","meta",null,{"name":"theme-color","media":"(prefers-color-scheme: dark)","content":"rgb(17,17,17)"}],"$undefined"]}],["$","body",null,{"children":["$","$Le",null,{"value":{"children":"$undefined","copyPageButton":true,"darkMode":true,"docsRepositoryBase":"https://github.com/pubpub/platform/tree/main/docs","editLink":"Edit this page","feedback":{"content":"Question? Give us feedback","labels":"feedback"},"i18n":[],"lastUpdated":["$","$Lf",null,{}],"navigation":{"next":true,"prev":true},"search":["$","$L10",null,{}],"sidebar":{"defaultMenuCollapseLevel":2,"defaultOpen":true,"toggleButton":true},"themeSwitch":{"dark":"Dark","light":"Light","system":"System"},"toc":{"backToTop":"Scroll to top","float":true,"title":"On This Page"}},"children":["$","$L11",null,{"attribute":"class","defaultTheme":"system","disableTransitionOnChange":true,"storageKey":"theme","children":[["$","$L12",null,{}],"$undefined",["$","$L13",null,{"pageMap":[{"data":{"infrastructure":{"title":"üèóÔ∏è Infrastructure"},"development":{"title":"üë©‚Äçüíª Development"}}},{"name":"index","route":"/","frontMatter":{"title":"Introduction","filePath":"content/index.mdx","timestamp":1759937674000},"title":"Introduction"},{"name":"infrastructure","route":"/infrastructure","children":[{"name":"ecs-cluster","route":"/infrastructure/ecs-cluster","frontMatter":{"title":"Terraform","filePath":"content/infrastructure/ecs-cluster.mdx","timestamp":1759937674000},"title":"Terraform"},{"name":"environments","route":"/infrastructure/environments","children":[{"name":"cloudflare","route":"/infrastructure/environments/cloudflare","frontMatter":{"title":"Global Cloudflare configuration","filePath":"content/infrastructure/environments/cloudflare.mdx","timestamp":1759937674000},"title":"Global Cloudflare configuration"},{"name":"global-aws","route":"/infrastructure/environments/global-aws","frontMatter":{"title":"Global AWS configurations","filePath":"content/infrastructure/environments/global-aws.mdx","timestamp":1759937674000},"title":"Global AWS configurations"}],"title":"Environments"},{"name":"modules","route":"/infrastructure/modules","children":[{"name":"core-services","route":"/infrastructure/modules/core-services","frontMatter":{"title":"Core Services","filePath":"content/infrastructure/modules/core-services.mdx","timestamp":1750086553000},"title":"Core Services"}],"title":"Modules"},{"name":"nginx","route":"/infrastructure/nginx","frontMatter":{"title":"Nginx","filePath":"content/infrastructure/nginx.mdx","timestamp":1759937674000},"title":"Nginx"}],"frontMatter":{"title":"Infrastructure","description":"Information about the infrastructure that runs PubPub.","sidebarTitle":"üèóÔ∏è Infrastructure","asIndexPage":true,"filePath":"content/infrastructure/index.mdx","timestamp":1759937674000},"title":"üèóÔ∏è Infrastructure"},{"name":"development","route":"/development","children":[{"data":{"getting-started":{},"common-issues":{},"concepts":{},"database":{},"testing":{"title":"üß™ Testing"}}},{"name":"getting-started","route":"/development/getting-started","frontMatter":{"title":"Getting started","filePath":"content/development/getting-started.mdx","timestamp":1750086553000},"title":"Getting started"},{"name":"common-issues","route":"/development/common-issues","frontMatter":{"title":"Issues you may run into","filePath":"content/development/common-issues.mdx","timestamp":1759937674000},"title":"Issues you may run into"},{"name":"concepts","route":"/development/concepts","children":[{"name":"authorization","route":"/development/concepts/authorization","frontMatter":{"title":"Capabilities","filePath":"content/development/concepts/authorization.mdx","timestamp":1753282322000},"title":"Capabilities"},{"name":"invites","route":"/development/concepts/invites","frontMatter":{"title":"Invites","filePath":"content/development/concepts/invites.mdx","timestamp":1750086553000},"title":"Invites"},{"name":"richtext","route":"/development/concepts/richtext","frontMatter":{"title":"Rich Text Fields","filePath":"content/development/concepts/richtext.mdx","timestamp":1750086553000},"title":"Rich Text Fields"},{"name":"serverActions","route":"/development/concepts/serverActions","frontMatter":{"title":"Server Actions","filePath":"content/development/concepts/serverActions.mdx","timestamp":1750086553000},"title":"Server Actions"}],"title":"Concepts"},{"name":"database","route":"/development/database","children":[{"name":"1-prisma","route":"/development/database/1-prisma","frontMatter":{"title":"Prisma (migrations)","filePath":"content/development/database/1-prisma.mdx","timestamp":1759937674000},"title":"Prisma (migrations)"},{"name":"2-kanel-type-generation","route":"/development/database/2-kanel-type-generation","frontMatter":{"title":"Kanel (type generation)","filePath":"content/development/database/2-kanel-type-generation.mdx","timestamp":1750086553000},"title":"Kanel (type generation)"},{"name":"3-kysely","route":"/development/database/3-kysely","frontMatter":{"title":"Kysely (query builder)","filePath":"content/development/database/3-kysely.mdx","timestamp":1759937674000},"title":"Kysely (query builder)"},{"name":"4-caching","route":"/development/database/4-caching","frontMatter":{"title":"Caching","filePath":"content/development/database/4-caching.mdx","timestamp":1759937674000},"title":"Caching"}],"frontMatter":{"title":"Database","description":"How we manage our database","sidebarTitle":"üíæ Database","asIndexPage":true,"filePath":"content/development/database/index.mdx","timestamp":1759937674000},"title":"üíæ Database"},{"name":"testing","route":"/development/testing","children":[{"name":"1-e2e-tests","route":"/development/testing/1-e2e-tests","frontMatter":{"title":"E2E Tests","filePath":"content/development/testing/1-e2e-tests.mdx","timestamp":1759937674000},"title":"E2E Tests"},{"name":"2-load-testing","route":"/development/testing/2-load-testing","frontMatter":{"title":"Load Testing","filePath":"content/development/testing/2-load-testing.mdx","timestamp":1759937674000},"title":"Load Testing"},{"name":"3-TODO-vitest","route":"/development/testing/3-TODO-vitest","frontMatter":{"title":"TODO: Add docs for how to run vitest tests","filePath":"content/development/testing/3-TODO-vitest.mdx","timestamp":1759937674000},"title":"TODO: Add docs for how to run vitest tests"}],"title":"üß™ Testing"}],"title":"üë©‚Äçüíª Development"}],"navbar":"$L14","footer":"$L15","children":["$L16","$L17"]}]]}]}]}]]}]
18:I[14325,["/platform/pr-preview/pr-1389/_next/static/chunks/dd28ad6c648d3915.js","/platform/pr-preview/pr-1389/_next/static/chunks/7c21ffbacf124703.js","/platform/pr-preview/pr-1389/_next/static/chunks/40c2ac68a22f3b83.js","/platform/pr-preview/pr-1389/_next/static/chunks/e2d6c8eabf052809.js"],""]
19:I[36817,["/platform/pr-preview/pr-1389/_next/static/chunks/dd28ad6c648d3915.js","/platform/pr-preview/pr-1389/_next/static/chunks/7c21ffbacf124703.js","/platform/pr-preview/pr-1389/_next/static/chunks/40c2ac68a22f3b83.js","/platform/pr-preview/pr-1389/_next/static/chunks/e2d6c8eabf052809.js"],"ClientNavbar"]
1b:I[92479,["/platform/pr-preview/pr-1389/_next/static/chunks/dd28ad6c648d3915.js","/platform/pr-preview/pr-1389/_next/static/chunks/7c21ffbacf124703.js","/platform/pr-preview/pr-1389/_next/static/chunks/40c2ac68a22f3b83.js","/platform/pr-preview/pr-1389/_next/static/chunks/e2d6c8eabf052809.js"],"Switchers"]
1c:I[65981,["/platform/pr-preview/pr-1389/_next/static/chunks/dd28ad6c648d3915.js","/platform/pr-preview/pr-1389/_next/static/chunks/7c21ffbacf124703.js","/platform/pr-preview/pr-1389/_next/static/chunks/40c2ac68a22f3b83.js","/platform/pr-preview/pr-1389/_next/static/chunks/e2d6c8eabf052809.js"],"LocaleSwitch"]
1d:I[94230,["/platform/pr-preview/pr-1389/_next/static/chunks/dd28ad6c648d3915.js","/platform/pr-preview/pr-1389/_next/static/chunks/7c21ffbacf124703.js","/platform/pr-preview/pr-1389/_next/static/chunks/40c2ac68a22f3b83.js","/platform/pr-preview/pr-1389/_next/static/chunks/e2d6c8eabf052809.js"],"ThemeSwitch"]
1e:I[99951,["/platform/pr-preview/pr-1389/_next/static/chunks/dd28ad6c648d3915.js","/platform/pr-preview/pr-1389/_next/static/chunks/7c21ffbacf124703.js","/platform/pr-preview/pr-1389/_next/static/chunks/40c2ac68a22f3b83.js","/platform/pr-preview/pr-1389/_next/static/chunks/e2d6c8eabf052809.js"],"MobileNav"]
:HL["/platform/pr-preview/pr-1389/logo.svg","image"]
1a:T481,M12 3C7.0275 3 3 7.12937 3 12.2276C3 16.3109 5.57625 19.7597 9.15374 20.9824C9.60374 21.0631 9.77249 20.7863 9.77249 20.5441C9.77249 20.3249 9.76125 19.5982 9.76125 18.8254C7.5 19.2522 6.915 18.2602 6.735 17.7412C6.63375 17.4759 6.19499 16.6569 5.8125 16.4378C5.4975 16.2647 5.0475 15.838 5.80124 15.8264C6.51 15.8149 7.01625 16.4954 7.18499 16.7723C7.99499 18.1679 9.28875 17.7758 9.80625 17.5335C9.885 16.9337 10.1212 16.53 10.38 16.2993C8.3775 16.0687 6.285 15.2728 6.285 11.7432C6.285 10.7397 6.63375 9.9092 7.20749 9.26326C7.1175 9.03257 6.8025 8.08674 7.2975 6.81794C7.2975 6.81794 8.05125 6.57571 9.77249 7.76377C10.4925 7.55615 11.2575 7.45234 12.0225 7.45234C12.7875 7.45234 13.5525 7.55615 14.2725 7.76377C15.9937 6.56418 16.7475 6.81794 16.7475 6.81794C17.2424 8.08674 16.9275 9.03257 16.8375 9.26326C17.4113 9.9092 17.76 10.7281 17.76 11.7432C17.76 15.2843 15.6563 16.0687 13.6537 16.2993C13.98 16.5877 14.2613 17.1414 14.2613 18.0065C14.2613 19.2407 14.25 20.2326 14.25 20.5441C14.25 20.7863 14.4188 21.0746 14.8688 20.9824C16.6554 20.364 18.2079 19.1866 19.3078 17.6162C20.4077 16.0457 20.9995 14.1611 21 12.2276C21 7.12937 16.9725 3 12 3Z14:["$","header",null,{"className":"nextra-navbar x:sticky x:top-0 x:z-30 x:w-full x:bg-transparent x:print:hidden x:max-md:[.nextra-banner:not([class$=hidden])~&]:top-(--nextra-banner-height)","children":[["$","div",null,{"className":"nextra-navbar-blur x:absolute x:-z-1 x:size-full nextra-border x:border-b x:backdrop-blur-md x:bg-nextra-bg/70"}],["$","nav",null,{"style":{"height":"var(--nextra-navbar-height)"},"className":"x:mx-auto x:flex x:max-w-(--nextra-content-width) x:items-center x:gap-4 x:pl-[max(env(safe-area-inset-left),1.5rem)] x:pr-[max(env(safe-area-inset-right),1.5rem)] x:justify-end","children":[["$","$L18",null,{"href":"/platform/pr-preview/pr-1389/","className":"x:flex x:items-center x:me-auto x:transition-opacity x:focus-visible:nextra-focus x:hover:opacity-75","aria-label":"Home page","children":["$","div",null,{"className":"flex items-center","children":[["$","img",null,{"src":"/platform/pr-preview/pr-1389/logo.svg","alt":"PubPub","height":"20","width":"20"}],["$","span",null,{"className":"ml-2 font-semibold","children":"PubPub Development Docs"}]]}]}],["$","$L19",null,{"className":"","children":[["$","a",null,{"href":"https://github.com/pubpub/platform","target":"_blank","rel":"noreferrer","children":[["$","svg",null,{"fill":"currentColor","viewBox":"3 3 18 18","height":"24","aria-label":"Project repository","children":["$","path",null,{"d":"$1a"}]}],false],"className":"x:focus-visible:nextra-focus"}],"$undefined","$undefined"]}]]}]]}]
15:["$","div",null,{"className":"x:bg-gray-100 x:pb-[env(safe-area-inset-bottom)] x:dark:bg-neutral-900 x:print:bg-transparent","children":[["$","$L1b",null,{"children":["$","div",null,{"className":"x:mx-auto x:flex x:max-w-(--nextra-content-width) x:gap-2 x:py-2 x:px-4","children":[["$","$L1c",null,{}],["$","$L1d",null,{}]]}]}],["$","hr",null,{"className":"nextra-border"}],["$","footer",null,{"className":"x:mx-auto x:flex x:max-w-(--nextra-content-width) x:justify-center x:py-12 x:text-gray-600 x:dark:text-gray-400 x:md:justify-start x:pl-[max(env(safe-area-inset-left),1.5rem)] x:pr-[max(env(safe-area-inset-right),1.5rem)]","children":["MIT ",2025," ¬© Knowledge Futures Inc."]}]]}]
16:["$","$L1e",null,{}]
17:["$","$L3",null,{"parallelRouterKey":"children","error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L4",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":[[["$","title",null,{"children":"404: This page could not be found."}],["$","div",null,{"style":{"fontFamily":"system-ui,\"Segoe UI\",Roboto,Helvetica,Arial,sans-serif,\"Apple Color Emoji\",\"Segoe UI Emoji\"","height":"100vh","textAlign":"center","display":"flex","flexDirection":"column","alignItems":"center","justifyContent":"center"},"children":["$","div",null,{"children":[["$","style",null,{"dangerouslySetInnerHTML":{"__html":"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}"}}],["$","h1",null,{"className":"next-error-h1","style":{"display":"inline-block","margin":"0 20px 0 0","padding":"0 23px 0 0","fontSize":24,"fontWeight":500,"verticalAlign":"top","lineHeight":"49px"},"children":404}],["$","div",null,{"style":{"display":"inline-block"},"children":["$","h2",null,{"style":{"fontSize":14,"fontWeight":400,"lineHeight":"49px","margin":0},"children":"This page could not be found."}]}]]}]}]],[]],"forbidden":"$undefined","unauthorized":"$undefined"}]
1f:I[74508,["/platform/pr-preview/pr-1389/_next/static/chunks/dd28ad6c648d3915.js","/platform/pr-preview/pr-1389/_next/static/chunks/7c21ffbacf124703.js","/platform/pr-preview/pr-1389/_next/static/chunks/40c2ac68a22f3b83.js","/platform/pr-preview/pr-1389/_next/static/chunks/e2d6c8eabf052809.js"],"TOCProvider"]
20:I[99951,["/platform/pr-preview/pr-1389/_next/static/chunks/dd28ad6c648d3915.js","/platform/pr-preview/pr-1389/_next/static/chunks/7c21ffbacf124703.js","/platform/pr-preview/pr-1389/_next/static/chunks/40c2ac68a22f3b83.js","/platform/pr-preview/pr-1389/_next/static/chunks/e2d6c8eabf052809.js"],"Sidebar"]
21:I[87765,["/platform/pr-preview/pr-1389/_next/static/chunks/dd28ad6c648d3915.js","/platform/pr-preview/pr-1389/_next/static/chunks/7c21ffbacf124703.js","/platform/pr-preview/pr-1389/_next/static/chunks/40c2ac68a22f3b83.js","/platform/pr-preview/pr-1389/_next/static/chunks/e2d6c8eabf052809.js"],"ClientWrapper"]
22:T12b8,---
title: Terraform
---

# ECS Cluster Environment

## Dependencies

### State file bucket/config

You must have some way of storing terraform state files.
We use and recommend the s3 backend, but you can change
that configuration. See `./environments` for examples of
configuring backend.

We store our terraform state in an S3 bucket created by
the `./environments/global_aws` directory, which has an
interactive setup, see that readme for more info.

## Change management and workflows

This code is here to make infrastructure declarative rather than imperative.
It secondarily includes modularization to make it hard for configuration to drift
between preproduction / production or open source deployments.
These are two separate concerns.

Declarative code changes are still managed imperatively with `terraform apply`,
which can be made partially or fully automatic.

In general, production changes are applied manually after we are satisfied with
preproduction, which may or may not be automatic. Developers should expect a flow like:

1. make a change to a shared module code
2. make matching change to configuration in ALL environment directories, so they can be reviewed together
3. apply this new SHA to staging and do validation as desired
4. apply this same SHA to production.

Now there is no drift between code, staging, and production - we are converged.

## Rollbacks

Generally, rollbacks are done in emergencies and are done first in prod. (If done first in staging, this is
really no different a process than a roll-forward). Rollbacks are the only situation in which we should expect
to deploy production from an off-main branch. Changes may be infrastructure or code. In the infrastructure workflow:

1. make changes to terraform code that seems to fix the issue and apply it to production
2. if it resolves the issue, figure out how it needs to be applied to pre-prod for consistency and open a PR
3. when this PR is merged, it deploys to pre-prod and we are converged.

In general, code rollbacks can be done without a re-build, by deploying an old SHA, but it is preferable
if there is time, to do a revert & roll-forward flow,
because some operations (primarily database migrations) operate on assumptions of monotonic time. Additionally
this flow makes it easier for rollbacks to include reverts of specific changes in the middle of the commit history
without reverting everything more recent.

## Adding/updating variables and configuration

Variables are the things that distinguish one environment from another. These include container variables and
certain extra values such as infrastructure scaling / footprint parameters. There is a tradeoff between ease
of configuration change and strength of guarantees given by similarity between staging and prod. First decide if
your change should be applied identically to each environment, or warrants an increase in drift.

To add a variable, modify some terraform resource that depends on it and then thread your way back up. The most
common case will be to add an environment variable to a container so will use that as example here:

1. modify `modules/deployment/main.tf` to add a variable to the appropriate invocation of `container-generic`.
1. modify `modules/deployment/variables.tf` to add the variable declaration. (This step is not needed if your new env var can be computed based on changes to the upstream infrastructure, such as a database URL.)
1. modify each invocation in `environments/*/main.tf` to add this new variable.

Proceed as above. Note that changes to task definitions (which include container configs) are not actually applied until you then trigger a new `deploy` using `act`/`mask` or the Github console.

## Adding secrets

Secrets are a special variety of environment variable, whose process is just like the above but with an extra step after `terraform apply` and before `mask ecs deploy`:

To provide secrets to ECS containers, you should put them in AWS Secrets Manager.
To do this, replicate the setup in `modules/core-services/main.tf`: create a resource
that declares the existence of the secret. Since the purpose of this model is to
avoid having copies of the secrets exist anywhere persistently except the single
locked-down place, naturally the secret value itself (the "version") can't be passed through terraform.

So you must one-time only, or when changing the secret,

1. go to the AWS Secrets Manager console
2. and choose your new secret
3. select "Retrieve secret value" (unintuitive, because there is no value yet)
4. Console says "Value does not yet exist" and button you just clicked becomes "Set secret value".
5. Probably, paste your secret in the "plain text" box (you can also do key-value pairs, but then must use the key in the address when retrieving.)5:["$","div",null,{"className":"x:mx-auto x:flex x:max-w-(--nextra-content-width)","children":["$","$L1f",null,{"value":[{"value":"Dependencies","id":"dependencies","depth":2},{"value":"State file bucket/config","id":"state-file-bucketconfig","depth":3},{"value":"Change management and workflows","id":"change-management-and-workflows","depth":2},{"value":"Rollbacks","id":"rollbacks","depth":2},{"value":"Adding/updating variables and configuration","id":"addingupdating-variables-and-configuration","depth":2},{"value":"Adding secrets","id":"adding-secrets","depth":2}],"children":[["$","$L20",null,{}],["$","$L21",null,{"metadata":"$2:props:children:1:props:children:props:children:props:children:2:props:pageMap:2:children:0:frontMatter","bottomContent":"$undefined","sourceCode":"$22","children":["$L23","$L24"]}]]}]}]
25:I[22915,["/platform/pr-preview/pr-1389/_next/static/chunks/dd28ad6c648d3915.js","/platform/pr-preview/pr-1389/_next/static/chunks/7c21ffbacf124703.js","/platform/pr-preview/pr-1389/_next/static/chunks/40c2ac68a22f3b83.js","/platform/pr-preview/pr-1389/_next/static/chunks/e2d6c8eabf052809.js"],"HeadingAnchor"]
23:["$","div",null,{"id":"nextra-skip-nav"}]
24:["$","main",null,{"data-pagefind-body":true,"children":[["$","h1",null,{"id":"$undefined","className":"x:tracking-tight x:text-slate-900 x:dark:text-slate-100 x:font-bold x:mt-2 x:text-4xl","children":["ECS Cluster Environment","$undefined"]}],"\n",["$","h2",null,{"id":"dependencies","className":"x:tracking-tight x:text-slate-900 x:dark:text-slate-100 x:font-semibold x:target:animate-[fade-in_1.5s] x:mt-10 x:border-b x:pb-1 x:text-3xl nextra-border","children":["Dependencies",["$","$L25",null,{"id":"dependencies"}]]}],"\n",["$","h3",null,{"id":"state-file-bucketconfig","className":"x:tracking-tight x:text-slate-900 x:dark:text-slate-100 x:font-semibold x:target:animate-[fade-in_1.5s] x:mt-8 x:text-2xl","children":["State file bucket/config",["$","$L25",null,{"id":"state-file-bucketconfig"}]]}],"\n",["$","p",null,{"className":"x:not-first:mt-[1.25em] x:leading-7","children":["You must have some way of storing terraform state files.\nWe use and recommend the s3 backend, but you can change\nthat configuration. See ",["$","code",null,{"className":"nextra-code","dir":"ltr","children":"./environments"}]," for examples of\nconfiguring backend."]}],"\n",["$","p",null,{"className":"x:not-first:mt-[1.25em] x:leading-7","children":["We store our terraform state in an S3 bucket created by\nthe ",["$","code",null,{"className":"nextra-code","dir":"ltr","children":"./environments/global_aws"}]," directory, which has an\ninteractive setup, see that readme for more info."]}],"\n",["$","h2",null,{"id":"change-management-and-workflows","className":"x:tracking-tight x:text-slate-900 x:dark:text-slate-100 x:font-semibold x:target:animate-[fade-in_1.5s] x:mt-10 x:border-b x:pb-1 x:text-3xl nextra-border","children":["Change management and workflows",["$","$L25",null,{"id":"change-management-and-workflows"}]]}],"\n",["$","p",null,{"className":"x:not-first:mt-[1.25em] x:leading-7","children":"This code is here to make infrastructure declarative rather than imperative.\nIt secondarily includes modularization to make it hard for configuration to drift\nbetween preproduction / production or open source deployments.\nThese are two separate concerns."}],"\n",["$","p",null,{"className":"x:not-first:mt-[1.25em] x:leading-7","children":["Declarative code changes are still managed imperatively with ",["$","code",null,{"className":"nextra-code","dir":"ltr","children":"terraform apply"}],",\nwhich can be made partially or fully automatic."]}],"\n",["$","p",null,{"className":"x:not-first:mt-[1.25em] x:leading-7","children":"In general, production changes are applied manually after we are satisfied with\npreproduction, which may or may not be automatic. Developers should expect a flow like:"}],"\n",["$","ol",null,{"className":"x:[:is(ol,ul)_&]:my-[.75em] x:not-first:mt-[1.25em] x:list-decimal x:ms-6","children":["\n",["$","li",null,{"className":"x:my-[.5em]","children":"make a change to a shared module code"}],"\n",["$","li",null,{"className":"x:my-[.5em]","children":"make matching change to configuration in ALL environment directories, so they can be reviewed together"}],"\n",["$","li",null,{"className":"x:my-[.5em]","children":"apply this new SHA to staging and do validation as desired"}],"\n",["$","li",null,{"className":"x:my-[.5em]","children":"apply this same SHA to production."}],"\n"]}],"\n",["$","p",null,{"className":"x:not-first:mt-[1.25em] x:leading-7","children":"Now there is no drift between code, staging, and production - we are converged."}],"\n",["$","h2",null,{"id":"rollbacks","className":"x:tracking-tight x:text-slate-900 x:dark:text-slate-100 x:font-semibold x:target:animate-[fade-in_1.5s] x:mt-10 x:border-b x:pb-1 x:text-3xl nextra-border","children":["Rollbacks",["$","$L25",null,{"id":"rollbacks"}]]}],"\n",["$","p",null,{"className":"x:not-first:mt-[1.25em] x:leading-7","children":"Generally, rollbacks are done in emergencies and are done first in prod. (If done first in staging, this is\nreally no different a process than a roll-forward). Rollbacks are the only situation in which we should expect\nto deploy production from an off-main branch. Changes may be infrastructure or code. In the infrastructure workflow:"}],"\n","$L26","\n","$L27","\n","$L28","\n","$L29","\n","$L2a","\n","$L2b","\n","$L2c","\n","$L2d","\n","$L2e","\n","$L2f","\n","$L30","\n","$L31"]}]
26:["$","ol",null,{"className":"x:[:is(ol,ul)_&]:my-[.75em] x:not-first:mt-[1.25em] x:list-decimal x:ms-6","children":["\n",["$","li",null,{"className":"x:my-[.5em]","children":"make changes to terraform code that seems to fix the issue and apply it to production"}],"\n",["$","li",null,{"className":"x:my-[.5em]","children":"if it resolves the issue, figure out how it needs to be applied to pre-prod for consistency and open a PR"}],"\n",["$","li",null,{"className":"x:my-[.5em]","children":"when this PR is merged, it deploys to pre-prod and we are converged."}],"\n"]}]
27:["$","p",null,{"className":"x:not-first:mt-[1.25em] x:leading-7","children":"In general, code rollbacks can be done without a re-build, by deploying an old SHA, but it is preferable\nif there is time, to do a revert & roll-forward flow,\nbecause some operations (primarily database migrations) operate on assumptions of monotonic time. Additionally\nthis flow makes it easier for rollbacks to include reverts of specific changes in the middle of the commit history\nwithout reverting everything more recent."}]
28:["$","h2",null,{"id":"addingupdating-variables-and-configuration","className":"x:tracking-tight x:text-slate-900 x:dark:text-slate-100 x:font-semibold x:target:animate-[fade-in_1.5s] x:mt-10 x:border-b x:pb-1 x:text-3xl nextra-border","children":["Adding/updating variables and configuration",["$","$L25",null,{"id":"addingupdating-variables-and-configuration"}]]}]
29:["$","p",null,{"className":"x:not-first:mt-[1.25em] x:leading-7","children":"Variables are the things that distinguish one environment from another. These include container variables and\ncertain extra values such as infrastructure scaling / footprint parameters. There is a tradeoff between ease\nof configuration change and strength of guarantees given by similarity between staging and prod. First decide if\nyour change should be applied identically to each environment, or warrants an increase in drift."}]
2a:["$","p",null,{"className":"x:not-first:mt-[1.25em] x:leading-7","children":"To add a variable, modify some terraform resource that depends on it and then thread your way back up. The most\ncommon case will be to add an environment variable to a container so will use that as example here:"}]
2b:["$","ol",null,{"className":"x:[:is(ol,ul)_&]:my-[.75em] x:not-first:mt-[1.25em] x:list-decimal x:ms-6","children":["\n",["$","li",null,{"className":"x:my-[.5em]","children":["modify ",["$","code",null,{"className":"nextra-code","dir":"ltr","children":"modules/deployment/main.tf"}]," to add a variable to the appropriate invocation of ",["$","code",null,{"className":"nextra-code","dir":"ltr","children":"container-generic"}],"."]}],"\n",["$","li",null,{"className":"x:my-[.5em]","children":["modify ",["$","code",null,{"className":"nextra-code","dir":"ltr","children":"modules/deployment/variables.tf"}]," to add the variable declaration. (This step is not needed if your new env var can be computed based on changes to the upstream infrastructure, such as a database URL.)"]}],"\n",["$","li",null,{"className":"x:my-[.5em]","children":["modify each invocation in ",["$","code",null,{"className":"nextra-code","dir":"ltr","children":"environments/*/main.tf"}]," to add this new variable."]}],"\n"]}]
2c:["$","p",null,{"className":"x:not-first:mt-[1.25em] x:leading-7","children":["Proceed as above. Note that changes to task definitions (which include container configs) are not actually applied until you then trigger a new ",["$","code",null,{"className":"nextra-code","dir":"ltr","children":"deploy"}]," using ",["$","code",null,{"className":"nextra-code","dir":"ltr","children":"act"}],"/",["$","code",null,{"className":"nextra-code","dir":"ltr","children":"mask"}]," or the Github console."]}]
2d:["$","h2",null,{"id":"adding-secrets","className":"x:tracking-tight x:text-slate-900 x:dark:text-slate-100 x:font-semibold x:target:animate-[fade-in_1.5s] x:mt-10 x:border-b x:pb-1 x:text-3xl nextra-border","children":["Adding secrets",["$","$L25",null,{"id":"adding-secrets"}]]}]
2e:["$","p",null,{"className":"x:not-first:mt-[1.25em] x:leading-7","children":["Secrets are a special variety of environment variable, whose process is just like the above but with an extra step after ",["$","code",null,{"className":"nextra-code","dir":"ltr","children":"terraform apply"}]," and before ",["$","code",null,{"className":"nextra-code","dir":"ltr","children":"mask ecs deploy"}],":"]}]
2f:["$","p",null,{"className":"x:not-first:mt-[1.25em] x:leading-7","children":["To provide secrets to ECS containers, you should put them in AWS Secrets Manager.\nTo do this, replicate the setup in ",["$","code",null,{"className":"nextra-code","dir":"ltr","children":"modules/core-services/main.tf"}],": create a resource\nthat declares the existence of the secret. Since the purpose of this model is to\navoid having copies of the secrets exist anywhere persistently except the single\nlocked-down place, naturally the secret value itself (the ‚Äúversion‚Äù) can‚Äôt be passed through terraform."]}]
30:["$","p",null,{"className":"x:not-first:mt-[1.25em] x:leading-7","children":"So you must one-time only, or when changing the secret,"}]
31:["$","ol",null,{"className":"x:[:is(ol,ul)_&]:my-[.75em] x:not-first:mt-[1.25em] x:list-decimal x:ms-6","children":["\n",["$","li",null,{"className":"x:my-[.5em]","children":"go to the AWS Secrets Manager console"}],"\n",["$","li",null,{"className":"x:my-[.5em]","children":"and choose your new secret"}],"\n",["$","li",null,{"className":"x:my-[.5em]","children":"select ‚ÄúRetrieve secret value‚Äù (unintuitive, because there is no value yet)"}],"\n",["$","li",null,{"className":"x:my-[.5em]","children":"Console says ‚ÄúValue does not yet exist‚Äù and button you just clicked becomes ‚ÄúSet secret value‚Äù."}],"\n",["$","li",null,{"className":"x:my-[.5em]","children":"Probably, paste your secret in the ‚Äúplain text‚Äù box (you can also do key-value pairs, but then must use the key in the address when retrieving.)"}],"\n"]}]
a:[["$","meta","0",{"charSet":"utf-8"}],["$","meta","1",{"name":"viewport","content":"width=device-width, initial-scale=1"}]]
32:I[77462,["/platform/pr-preview/pr-1389/_next/static/chunks/aeacce398bb52d2f.js","/platform/pr-preview/pr-1389/_next/static/chunks/688156694ad04c7c.js"],"IconMark"]
c:[["$","title","0",{"children":"Terraform | PubPub Developer Docs"}],["$","link","1",{"rel":"icon","href":"/platform/pr-preview/pr-1389/favicon.ico?favicon.2c9e1857.ico","sizes":"48x48","type":"image/x-icon"}],["$","$L32","2",{}]]
8:null
