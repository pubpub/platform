services:
    core:
        build:
            context: .
            args:
                - PACKAGE=core
        container_name: core
        env_file: ./.env.docker-compose
        environment:
            #s non secret
            - ASSETS_BUCKET_NAME=assets.byron.pubpub.org
            - MAILGUN_SMTP_HOST=smtp.mailgun.org
            - MAILGUN_SMTP_PORT=465
            - MAILGUN_SMTP_USERNAME=omitted
            - OTEL_SERVICE_NAME=core.core
            - PGDATABASE=postgres
            - PGHOST=host.docker.internal
            - PGPORT=54322
            - PGUSER=postgres
            - PGPASSWORD=postgres
            - PUBPUB_URL=http://localhost:8080
        networks:
            - app-network
        ports:
            - "30000:3000"

    core-nginx:
        build: ./infrastructure/nginx
        container_name: core-nginx
        environment:
            - NGINX_LISTEN_PORT=8080
            - NGINX_PREFIX=/
            - NGINX_UPSTREAM_HOST=core
            - NGINX_UPSTREAM_PORT=3000
            - OTEL_SERVICE_NAME=core.nginx
        depends_on:
            - core
        networks:
            - app-network
        ports:
            - "3000:8080"

    jobs:
        build:
            context: .
            args:
                - PACKAGE=jobs
        container_name: jobs
        env_file: ./.env.docker-compose
        environment:
            - OTEL_SERVICE_NAME=jobs.jobs
            - PGDATABASE=postgres
            - PGHOST=host.docker.internal
            - PGPORT=54322
            - PGUSER=postgres
            - PGPASSWORD=postgres
            - PUBPUB_URL=http://localhost:8080
        networks:
            - app-network

    # for local file uploads
    minio:
        extends:
            file: docker-compose.base.yml
            service: minio
        env_file:
            - path: "./.env.docker-compose"
              required: false
        networks:
            - app-network
        volumes:
            - ${CURRENT_WORKING_DIR}/.local_data/files:/data
        ports:
            - "9000:9000"

    minio-init:
        image: minio/mc:latest
        depends_on:
            minio:
                condition: service_healthy
        networks:
            - app-network
        entrypoint: >
            /bin/sh -c "
            /usr/bin/mc config host add myminio http://minio:9000 ${MINIO_ACCESS_KEY:-minioadmin} ${MINIO_SECRET_KEY:-minioadmin};
            /usr/bin/mc mb --ignore-existing myminio/${ASSETS_BUCKET_NAME:-assets.v7.pubpub.org};
            /usr/bin/mc anonymous set download myminio/${ASSETS_BUCKET_NAME:-assets.v7.pubpub.org};
            /usr/bin/mc admin user add myminio ${ASSETS_UPLOAD_KEY:-pubpubuser} ${ASSETS_UPLOAD_SECRET_KEY:-pubpubpass};
            /usr/bin/mc admin policy attach myminio readwrite --user ${ASSETS_UPLOAD_KEY:-pubpubuser};
            exit 0;
            "

    # jobs-nginx:
    # No Nginx for jobs, because it does not take requests

    db:
        extends:
            file: docker-compose.base.yml
            service: db
        volumes:
            - postgres-data:/var/lib/postgresql/data

    inbucket:
        extends:
            file: docker-compose.base.yml
            service: inbucket

networks:
    app-network:

volumes:
    postgres-data:
        driver: local
