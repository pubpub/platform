ALTER TABLE "pub_values" ADD COLUMN "rank" TEXT;

WITH "mudder_ranks" AS (
  SELECT "m".* FROM (
    VALUES (0,'01'), (1,'03'), (2,'05'), (3,'07'), (4,'09'), (5,'0B'), (6,'0D'),
    (7,'0F'), (8,'0H'), (9,'0J'), (10,'0L'), (11,'0N'), (12,'0O'), (13,'0Q'),
    (14,'0S'), (15,'0U'), (16,'0W'), (17,'0Y'), (18,'0a'), (19,'0c'), (20,'0e'),
    (21,'0g'), (22,'0i'), (23,'0k'), (24,'0m'), (25,'0n'), (26,'0p'), (27,'0r'),
    (28,'0t'), (29,'0v'), (30,'0x'), (31,'0z'), (32,'1'), (33,'13'), (34,'15'),
    (35,'17'), (36,'19'), (37,'1B'), (38,'1C'), (39,'1E'), (40,'1G'), (41,'1I'),
    (42,'1K'), (43,'1M'), (44,'1O'), (45,'1Q'), (46,'1S'), (47,'1U'), (48,'1W'),
    (49,'1Y'), (50,'1a'), (51,'1b'), (52,'1d'), (53,'1f'), (54,'1h'), (55,'1j'),
    (56,'1l'), (57,'1n'), (58,'1p'), (59,'1r'), (60,'1t'), (61,'1v'), (62,'1x'),
    (63,'1z'), (64,'2'), (65,'22'), (66,'24'), (67,'26'), (68,'28'), (69,'2A'),
    (70,'2C'), (71,'2E'), (72,'2G'), (73,'2I'), (74,'2K'), (75,'2M'), (76,'2N'),
    (77,'2P'), (78,'2R'), (79,'2T'), (80,'2V'), (81,'2X'), (82,'2Z'), (83,'2b'),
    (84,'2d'), (85,'2f'), (86,'2h'), (87,'2j'), (88,'2l'), (89,'2m'), (90,'2o'),
    (91,'2q'), (92,'2s'), (93,'2u'), (94,'2w'), (95,'2y'), (96,'3'), (97,'32'),
    (98,'34'), (99,'36'), (100,'38'), (101,'3A'), (102,'3B'), (103,'3D'),
    (104,'3F'), (105,'3H'), (106,'3J'), (107,'3L'), (108,'3N'), (109,'3P'),
    (110,'3R'), (111,'3T'), (112,'3V'), (113,'3X'), (114,'3Z'), (115,'3a'),
    (116,'3c'), (117,'3e'), (118,'3g'), (119,'3i'), (120,'3k'), (121,'3m'),
    (122,'3o'), (123,'3q'), (124,'3s'), (125,'3u'), (126,'3w'), (127,'3y'),
    (128,'3z'), (129,'4'), (130,'43'), (131,'45'), (132,'47'), (133,'49'),
    (134,'4B'), (135,'4D'), (136,'4F'), (137,'4H'), (138,'4J'), (139,'4L'),
    (140,'4N'), (141,'4O'), (142,'4Q'), (143,'4S'), (144,'4U'), (145,'4W'),
    (146,'4Y'), (147,'4a'), (148,'4c'), (149,'4e'), (150,'4g'), (151,'4i'),
    (152,'4k'), (153,'4l'), (154,'4n'), (155,'4p'), (156,'4r'), (157,'4t'),
    (158,'4v'), (159,'4x'), (160,'4z'), (161,'5'), (162,'53'), (163,'55'),
    (164,'57'), (165,'59'), (166,'5A'), (167,'5C'), (168,'5E'), (169,'5G'),
    (170,'5I'), (171,'5K'), (172,'5M'), (173,'5O'), (174,'5Q'), (175,'5S'),
    (176,'5U'), (177,'5W'), (178,'5Y'), (179,'5Z'), (180,'5b'), (181,'5d'),
    (182,'5f'), (183,'5h'), (184,'5j'), (185,'5l'), (186,'5n'), (187,'5p'),
    (188,'5r'), (189,'5t'), (190,'5v'), (191,'5x'), (192,'5y'), (193,'6'),
    (194,'62'), (195,'64'), (196,'66'), (197,'68'), (198,'6A'), (199,'6C')
  ) AS "m"("index", "rank")
),
"related_pubs" AS (
  SELECT "pubId", "fieldId"
  FROM "pub_values"
  WHERE "relatedPubId" IS NOT NULL
  GROUP BY "pubId", "fieldId"
  HAVING COUNT("pubId") > 1
),
"row_numbers" AS (
  SELECT 
    "pub_values"."id", 
    ROW_NUMBER() OVER (
      PARTITION BY "pub_values"."pubId", "pub_values"."fieldId" 
      ORDER BY "pub_values"."updatedAt"
    ) as "r"
  FROM "pub_values"
  JOIN "related_pubs" ON 
    "related_pubs"."pubId" = "pub_values"."pubId" 
    AND "related_pubs"."fieldId" = "pub_values"."fieldId"
)
UPDATE "pub_values" 
SET 
  "rank" = "mudder_ranks"."rank", 
  "lastModifiedBy" = 'system|' || FLOOR(EXTRACT(EPOCH FROM CURRENT_TIMESTAMP) * 1000)
FROM "mudder_ranks", "row_numbers"
WHERE 
  "mudder_ranks"."index" = "row_numbers"."r"
  AND "row_numbers"."id" = "pub_values"."id";