# Based on https://docs.github.com/en/actions/deployment/deploying-to-your-cloud-provider/deploying-to-amazon-elastic-container-service

name: docker build to ECR

on:
    workflow_call:
        secrets:
            AWS_ACCESS_KEY_ID:
                required: true
            AWS_SECRET_ACCESS_KEY:
                required: true

jobs:
    # TODO: restore the commented `needs` lines once we implement
    # Docker build caching in github actions
    build-base:
        uses: ./.github/workflows/ecrbuild-template.yml
        secrets:
            AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
            AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}

    build-core:
        uses: ./.github/workflows/ecrbuild-template.yml
        # needs:
        #   - build-base
        with:
            package: core
        secrets:
            AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
            AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}

    build-intg-submissions:
        uses: ./.github/workflows/ecrbuild-template.yml
        # needs:
        #   - build-base
        with:
            package: integration-submissions
        secrets:
            AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
            AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}

    build-jobs:
        uses: ./.github/workflows/ecrbuild-template.yml
        # needs:
        #   - build-base
        with:
            package: jobs
        secrets:
            AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
            AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}

    build-intg-evaluations:
        uses: ./.github/workflows/ecrbuild-template.yml
        # needs:
        #   - build-base
        with:
            package: integration-evaluations
        secrets:
            AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
            AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
