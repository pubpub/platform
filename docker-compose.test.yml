# yaml-language-server: $schema=https://raw.githubusercontent.com/compose-spec/compose-spec/master/schema/compose-spec.json

services:
    db:
        extends:
            file: ./docker-compose.base.yml
            service: db
        env_file:
            - path: .env.docker-compose.test
              required: true
        volumes:
            - postgres_test_data:/var/lib/postgresql/data
        networks:
            - app-network
        profiles:
            - test
            - integration
        ports:
            - 54323:5432

    minio:
        extends:
            file: ./docker-compose.base.yml
            service: minio
        env_file:
            - path: .env.docker-compose.test
              required: true
        volumes:
            - minio_data:/data
        networks:
            - app-network
        profiles:
            - integration

    minio-init:
        depends_on:
            minio:
                condition: service_healthy
        env_file:
            - path: .env.docker-compose.test
              required: true
        extends:
            file: ./docker-compose.base.yml
            service: minio-init
        networks:
            - app-network
        profiles:
            - integration

    inbucket:
        extends:
            file: ./docker-compose.base.yml
            service: inbucket
        env_file:
            - path: .env.docker-compose.test
              required: true
        networks:
            - app-network
        profiles:
            - test
            - integration

    jobs:
        container_name: jobs
        image: ${JOBS_IMAGE}
        platform: linux/amd64
        env_file:
            - path: .env.docker-compose.test
              required: true
        environment:
            - OTEL_SERVICE_NAME=jobs.jobs
            - PGDATABASE=${POSTGRES_DB}
            - PGHOST=db
            - PGPORT=${POSTGRES_PORT}
            - PGUSER=${POSTGRES_USER}
            - PGPASSWORD=${POSTGRES_PASSWORD}
            - PUBPUB_URL=http://localhost:3000
        networks:
            - app-network
        depends_on:
            - db
        profiles:
            - integration

    integration-tests:
        image: ${INTEGRATION_TESTS_IMAGE}
        env_file:
            - path: .env.docker-compose.test
              required: true
        environment:
            # this needs to be db:5432 bc that's what it is in the app-network
            # if you are running this from outside the docker network, you need to use
            # @localhost:${POSTGRES_PORT} instead
            - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@db:5432/${POSTGRES_DB}
            - PORT=3000
            - CI=true
        depends_on:
            jobs:
                # TODO: add a healthcheck for jobs
                condition: service_started
            db:
                condition: service_started
            inbucket:
                condition: service_started
        platform: linux/amd64
        healthcheck:
            test: ["CMD-SHELL", "curl http://integration-tests:3000/api/health"]
            interval: 10s
            timeout: 5s
            retries: 5
        profiles:
            - integration
        ports:
            - 3000:3000
        networks:
            - app-network

volumes:
    minio_data:
    postgres_test_data:
        driver: local

networks:
    app-network:
